{
  "id": "task_205_config",
  "name": "Layered Configuration Manager",
  "description": "Configuration system with layers, validation, and type coercion",
  "tier": "tier3_integration",
  "prompt": "Create a layered configuration system with validation and type coercion.\n\nImplement in src/core/config_manager.py:\n\n1. `ConfigValue` class:\n   - `value: Any` - The actual value\n   - `source: str` - Where it came from ('default', 'file', 'env', 'override')\n   - `type_hint: type` - Expected type\n\n2. `ConfigSchema` for defining config structure:\n   - `define(key: str, type_hint: type, default: Any = None, required: bool = False, validator: Callable = None)`\n   - Validators return (is_valid, error_message)\n\n3. `ConfigManager` class:\n   - `__init__(self, schema: ConfigSchema)`\n   - `load_defaults()` - Load schema defaults (lowest priority)\n   - `load_dict(data: dict, source: str = 'file')` - Load from dict\n   - `load_env(prefix: str = '')` - Load from os.environ (e.g., APP_PORT with prefix='APP_' maps to 'port')\n   - `set(key: str, value: Any)` - Override value (highest priority)\n   - `get(key: str) -> Any` - Get resolved value\n   - `get_typed(key: str, type_hint: type) -> T` - Get with type coercion\n   - `get_or_default(key: str, default: Any) -> Any`\n   - `get_source(key: str) -> str` - Get value source\n   - `validate() -> list[str]` - Validate all values, return errors\n   - `to_dict() -> dict` - Export all config\n   - `keys() -> list[str]` - All defined keys\n\n4. Type coercion rules:\n   - str -> int: parse integer\n   - str -> float: parse float\n   - str -> bool: 'true'/'1'/'yes' -> True, 'false'/'0'/'no' -> False\n   - str -> list: split by comma\n\n5. Layer priority (highest to lowest): override > env > file > default\n\n6. Contracts should enforce:\n   - Required keys must have values\n   - Values must pass validation\n   - Type coercion must succeed",
  "initial_files": {},
  "test_file": "import pytest\nimport sys\nimport os\nsys.path.insert(0, 'src')\nfrom core.config_manager import ConfigManager, ConfigSchema\n\ndef test_default_value():\n    schema = ConfigSchema()\n    schema.define(\"port\", int, default=8080)\n    cm = ConfigManager(schema)\n    cm.load_defaults()\n    assert cm.get(\"port\") == 8080\n\ndef test_file_overrides_default():\n    schema = ConfigSchema()\n    schema.define(\"port\", int, default=8080)\n    cm = ConfigManager(schema)\n    cm.load_defaults()\n    cm.load_dict({\"port\": 9000})\n    assert cm.get(\"port\") == 9000\n\ndef test_override_highest_priority():\n    schema = ConfigSchema()\n    schema.define(\"port\", int, default=8080)\n    cm = ConfigManager(schema)\n    cm.load_defaults()\n    cm.load_dict({\"port\": 9000})\n    cm.set(\"port\", 3000)\n    assert cm.get(\"port\") == 3000\n\ndef test_type_coercion_str_to_int():\n    schema = ConfigSchema()\n    schema.define(\"port\", int, default=8080)\n    cm = ConfigManager(schema)\n    cm.load_dict({\"port\": \"9000\"})\n    assert cm.get_typed(\"port\", int) == 9000\n\ndef test_type_coercion_str_to_bool():\n    schema = ConfigSchema()\n    schema.define(\"debug\", bool, default=False)\n    cm = ConfigManager(schema)\n    cm.load_dict({\"debug\": \"true\"})\n    assert cm.get_typed(\"debug\", bool) is True\n\ndef test_get_source():\n    schema = ConfigSchema()\n    schema.define(\"port\", int, default=8080)\n    cm = ConfigManager(schema)\n    cm.load_defaults()\n    assert cm.get_source(\"port\") == \"default\"\n    cm.load_dict({\"port\": 9000})\n    assert cm.get_source(\"port\") == \"file\"\n\ndef test_validate_required():\n    schema = ConfigSchema()\n    schema.define(\"api_key\", str, required=True)\n    cm = ConfigManager(schema)\n    errors = cm.validate()\n    assert len(errors) > 0\n    assert \"api_key\" in errors[0]\n",
  "hidden_test_file": "import pytest\nimport sys\nimport os\nsys.path.insert(0, 'src')\nfrom core.config_manager import ConfigManager, ConfigSchema\n\n# Support both ValueError and deal.PreContractError for contract violations\ntry:\n    import deal\n    CONTRACT_ERROR = (ValueError, deal.PreContractError)\nexcept ImportError:\n    CONTRACT_ERROR = ValueError\n\n\ndef test_custom_validator():\n    def port_validator(value):\n        if 1 <= value <= 65535:\n            return True, None\n        return False, \"Port must be 1-65535\"\n    \n    schema = ConfigSchema()\n    schema.define(\"port\", int, default=8080, validator=port_validator)\n    cm = ConfigManager(schema)\n    cm.load_dict({\"port\": 70000})\n    errors = cm.validate()\n    assert len(errors) > 0\n\ndef test_env_loading(monkeypatch):\n    monkeypatch.setenv(\"APP_PORT\", \"5000\")\n    schema = ConfigSchema()\n    schema.define(\"port\", int, default=8080)\n    cm = ConfigManager(schema)\n    cm.load_env(prefix=\"APP_\")\n    assert cm.get_typed(\"port\", int) == 5000\n\ndef test_str_to_list():\n    schema = ConfigSchema()\n    schema.define(\"hosts\", list, default=[])\n    cm = ConfigManager(schema)\n    cm.load_dict({\"hosts\": \"a,b,c\"})\n    result = cm.get_typed(\"hosts\", list)\n    assert result == [\"a\", \"b\", \"c\"]\n\ndef test_bool_false_values():\n    schema = ConfigSchema()\n    schema.define(\"flag\", bool, default=True)\n    cm = ConfigManager(schema)\n    \n    for val in [\"false\", \"0\", \"no\", \"False\", \"NO\"]:\n        cm.load_dict({\"flag\": val})\n        assert cm.get_typed(\"flag\", bool) is False\n\ndef test_to_dict():\n    schema = ConfigSchema()\n    schema.define(\"port\", int, default=8080)\n    schema.define(\"host\", str, default=\"localhost\")\n    cm = ConfigManager(schema)\n    cm.load_defaults()\n    d = cm.to_dict()\n    assert d[\"port\"] == 8080\n    assert d[\"host\"] == \"localhost\"\n\ndef test_keys():\n    schema = ConfigSchema()\n    schema.define(\"a\", int, default=1)\n    schema.define(\"b\", str, default=\"x\")\n    cm = ConfigManager(schema)\n    assert set(cm.keys()) == {\"a\", \"b\"}\n\ndef test_get_or_default():\n    schema = ConfigSchema()\n    schema.define(\"port\", int)  # No default\n    cm = ConfigManager(schema)\n    assert cm.get_or_default(\"port\", 9999) == 9999\n\ndef test_invalid_type_coercion():\n    schema = ConfigSchema()\n    schema.define(\"port\", int, default=8080)\n    cm = ConfigManager(schema)\n    cm.load_dict({\"port\": \"not_a_number\"})\n    with pytest.raises(CONTRACT_ERROR):\n        cm.get_typed(\"port\", int)\n\ndef test_undefined_key():\n    schema = ConfigSchema()\n    cm = ConfigManager(schema)\n    assert cm.get(\"undefined\") is None\n    assert cm.get_or_default(\"undefined\", \"fallback\") == \"fallback\"\n\ndef test_layer_priority_complete():\n    schema = ConfigSchema()\n    schema.define(\"val\", str, default=\"default\")\n    cm = ConfigManager(schema)\n    cm.load_defaults()\n    assert cm.get(\"val\") == \"default\"\n    cm.load_dict({\"val\": \"from_file\"})\n    assert cm.get(\"val\") == \"from_file\"\n    cm.set(\"val\", \"override\")\n    assert cm.get(\"val\") == \"override\"\n",
  "expected_files": [
    "src/core/config_manager.py"
  ],
  "tags": [
    "configuration",
    "layers",
    "coercion",
    "validation"
  ],
  "difficulty": "hard"
}
