{
  "id": "task_103_state_machine",
  "name": "Order State Machine",
  "description": "Implement an order state machine with preconditions for valid state transitions.",
  "tier": "tier2_contracts",
  "prompt": "Implement an Order state machine in `src/core/order.py`:\n\nStates: PENDING, CONFIRMED, SHIPPED, DELIVERED, CANCELLED\n\nValid transitions:\n- PENDING -> CONFIRMED (confirm)\n- PENDING -> CANCELLED (cancel)\n- CONFIRMED -> SHIPPED (ship)\n- CONFIRMED -> CANCELLED (cancel)\n- SHIPPED -> DELIVERED (deliver)\n\nImplement:\n\n1. `OrderStatus` enum with all states\n\n2. `Order` dataclass with:\n   - id: str\n   - status: OrderStatus\n   - items: list[str]\n\n3. Transition functions with precondition contracts:\n   - `confirm_order(order: Order) -> Order`\n     - Pre: order.status == PENDING\n     - Post: result.status == CONFIRMED\n   \n   - `ship_order(order: Order) -> Order`\n     - Pre: order.status == CONFIRMED\n     - Post: result.status == SHIPPED\n   \n   - `deliver_order(order: Order) -> Order`\n     - Pre: order.status == SHIPPED\n     - Post: result.status == DELIVERED\n   \n   - `cancel_order(order: Order) -> Order`\n     - Pre: order.status in (PENDING, CONFIRMED)\n     - Post: result.status == CANCELLED\n\n4. `can_transition(order: Order, target: OrderStatus) -> bool`\n   - Returns whether the transition is valid\n\nUse @pre/@post from deal. Include doctests.",
  "initial_files": {
    "src/core/__init__.py": "",
    "src/shell/__init__.py": "",
    "tests/__init__.py": "",
    "pyproject.toml": "[project]\nname = \"task\"\nversion = \"0.1.0\"\n\n[project.optional-dependencies]\ndev = [\"deal\", \"pytest\"]\n"
  },
  "test_file": "import pytest\nfrom src.core.order import Order, OrderStatus, confirm_order, ship_order, deliver_order, cancel_order, can_transition\n\n\ndef test_create_order():\n    order = Order(id=\"1\", status=OrderStatus.PENDING, items=[\"item1\"])\n    assert order.status == OrderStatus.PENDING\n\n\ndef test_confirm_pending():\n    order = Order(id=\"1\", status=OrderStatus.PENDING, items=[\"item1\"])\n    result = confirm_order(order)\n    assert result.status == OrderStatus.CONFIRMED\n\n\ndef test_ship_confirmed():\n    order = Order(id=\"1\", status=OrderStatus.CONFIRMED, items=[\"item1\"])\n    result = ship_order(order)\n    assert result.status == OrderStatus.SHIPPED\n\n\ndef test_deliver_shipped():\n    order = Order(id=\"1\", status=OrderStatus.SHIPPED, items=[\"item1\"])\n    result = deliver_order(order)\n    assert result.status == OrderStatus.DELIVERED\n\n\ndef test_cancel_pending():\n    order = Order(id=\"1\", status=OrderStatus.PENDING, items=[\"item1\"])\n    result = cancel_order(order)\n    assert result.status == OrderStatus.CANCELLED\n\n\ndef test_can_transition_valid():\n    order = Order(id=\"1\", status=OrderStatus.PENDING, items=[\"item1\"])\n    assert can_transition(order, OrderStatus.CONFIRMED) is True\n    assert can_transition(order, OrderStatus.CANCELLED) is True\n",
  "hidden_test_file": "import pytest\nfrom src.core.order import Order, OrderStatus, confirm_order, ship_order, deliver_order, cancel_order, can_transition\n\n\ndef test_cancel_confirmed():\n    order = Order(id=\"1\", status=OrderStatus.CONFIRMED, items=[\"item1\"])\n    result = cancel_order(order)\n    assert result.status == OrderStatus.CANCELLED\n\n\ndef test_cannot_cancel_shipped():\n    order = Order(id=\"1\", status=OrderStatus.SHIPPED, items=[\"item1\"])\n    assert can_transition(order, OrderStatus.CANCELLED) is False\n\n\ndef test_cannot_ship_pending():\n    order = Order(id=\"1\", status=OrderStatus.PENDING, items=[\"item1\"])\n    assert can_transition(order, OrderStatus.SHIPPED) is False\n\n\ndef test_cannot_confirm_delivered():\n    order = Order(id=\"1\", status=OrderStatus.DELIVERED, items=[\"item1\"])\n    assert can_transition(order, OrderStatus.CONFIRMED) is False\n\n\ndef test_immutability():\n    # Original order should not be modified\n    order = Order(id=\"1\", status=OrderStatus.PENDING, items=[\"item1\"])\n    result = confirm_order(order)\n    assert order.status == OrderStatus.PENDING\n    assert result.status == OrderStatus.CONFIRMED\n\n\ndef test_items_preserved():\n    items = [\"a\", \"b\", \"c\"]\n    order = Order(id=\"1\", status=OrderStatus.PENDING, items=items)\n    result = confirm_order(order)\n    assert result.items == items\n",
  "expected_files": ["src/core/order.py"],
  "tags": ["contracts", "state-machine", "precondition", "enum"],
  "difficulty": "hard"
}
